<% layout('/layouts/boilerplate') %>

<div class="container mt-4">

  <!-- ===== LISTING TITLE ===== -->
  <h3 class="mb-3 text-center text-md-start"><%= list.title %></h3>

  <!-- ===== LISTING CARD ===== -->
  <div class="row justify-content-center">
    <div class="col-12 col-md-8">
      <div class="card listing-card show-card">
        <img src="<%= list.image.url %>" class="card-img-top show-img" alt="listing_image">

        <div class="card-body">
          <p class="text-muted">
            Owned by: <%= list.owner ? list.owner.username : "Unknown" %>
          </p>

          <p><%= list.description %></p>
          <p><b>₹<%= list.price.toLocaleString("en-IN") %> / night</b></p>
          <p><%= list.location %>, <%= list.country %></p>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== EDIT / DELETE BUTTONS ===== -->
  <% if (currentUser && list.owner && list.owner._id.equals(currentUser._id)) { %>
    <div class="d-flex justify-content-center gap-3 my-3">
      <a href="/listings/<%= list._id %>/edit" class="btn btn-dark">Edit</a>

      <form method="POST" action="/listings/<%= list._id %>?_method=DELETE">
        <button class="btn btn-danger">Delete</button>
      </form>
    </div>
  <% } %>

  <!-- ===== REVIEW FORM ===== -->
  <% if (currentUser) { %>
    <div class="row justify-content-center mt-4">
      <div class="col-12 col-md-8">
        <div class="card p-3">
          <h5 class="mb-3">Leave a Review</h5>

          <form action="/listings/<%= list._id %>/reviews" method="POST" novalidate class="needs-validation">

            <div class="mb-3">
              <label class="form-label">Rating</label>
              <fieldset class="starability-slot">
                <input type="radio" id="no-rate" class="input-no-rate" name="review[rating]" value="0" checked />
                <input type="radio" id="r1" name="review[rating]" value="1" />
                <label for="r1">1</label>
                <input type="radio" id="r2" name="review[rating]" value="2" />
                <label for="r2">2</label>
                <input type="radio" id="r3" name="review[rating]" value="3" />
                <label for="r3">3</label>
                <input type="radio" id="r4" name="review[rating]" value="4" />
                <label for="r4">4</label>
                <input type="radio" id="r5" name="review[rating]" value="5" />
                <label for="r5">5</label>
              </fieldset>
            </div>

            <div class="mb-3">
              <label class="form-label">Comment</label>
              <textarea name="review[comment]" class="form-control" rows="3" required></textarea>
              <div class="invalid-feedback">Please add a comment!</div>
            </div>

            <button class="btn btn-dark w-100">Submit Review</button>
          </form>
        </div>
      </div>
    </div>
  <% } %>

  <!-- ===== ALL REVIEWS ===== -->
  <% if (list.reviews.length > 0) { %>
    <div class="row justify-content-center mt-4">
      <div class="col-12 col-md-8">
        <h5 class="mb-3">All Reviews</h5>

        <div class="row g-3">
          <% for (let review of list.reviews) { %>
            <div class="col-12 col-md-6">
              <div class="card p-3 h-100 review-card">
                <div class="d-flex justify-content-between">
                  <strong>@<%= review.author.username %></strong>
                  <span class="text-warning">
                    <%= "★".repeat(review.rating) %><%= "☆".repeat(5 - review.rating) %>
                  </span>
                </div>

                <p class="mt-2 text-muted"><%= review.comment %></p>

                <% if (currentUser && review.author._id.equals(currentUser._id)) { %>
                  <form method="POST" action="/listings/<%= list._id %>/reviews/<%= review._id %>?_method=DELETE">
                    <button class="btn btn-sm btn-outline-danger w-100">Delete</button>
                  </form>
                <% } %>
              </div>
            </div>
          <% } %>
        </div>
      </div>
    </div>
  <% } %>

</div>
